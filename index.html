<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root{--accent:#007bff; --border:#d0d0d0; --bg-head:#f4f4f4; --err:#c00;}
    body{font-family:system-ui,sans-serif;margin:1.5rem;line-height:1.5;}
    h1,h2{margin-top:1.5rem;font-size:1.8rem;}h2{font-size:1.4rem;}
    a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid var(--border);padding:0.45rem 0.6rem;text-align:left;vertical-align:top;}
    th{background:var(--bg-head);}img{max-width:320px;height:auto;display:block;margin:1rem 0;border-radius:0.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.08);} .back{display:inline-block;margin-bottom:1rem;font-size:0.9rem;} .err{color:var(--err);max-width:600px;}
    .status{display:inline-block;width:0.8rem;height:0.8rem;border-radius:50%;vertical-align:middle;margin-right:0.4rem;}
    .status.ok{background:#28a745;}
    .status.no{background:#dc3545;}
  </style>
</head>
<body>
  <div id="app">Loading …</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* === CONFIG FOR PUBLISHED SHEET ===================================== */
  // Base URL of the "Published to web" Google Sheet (e.g. your pubhtml link minus "/pubhtml")
  const PUB_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwUNtFVPmX6ltXE7XyM12GlTYBTjadWSeUSbUZL7_IFYQANa2o-FSj9gDIAWxH2T-lse9nvlEyMQUL';

  // Map each logical sheet to its GID in the published sheet
  const SHEETS = {
    INVENTORY: { gid: 0 },       // replace 0 with the actual GID of your "Inventory" sheet
    RECIPES:   { gid: 123456789 } // replace 123456789 with the actual GID of your "DrinkList" sheet
  };
  const CURRENCY   = '€';
  const REFRESH_MS = 5 * 60 * 1000;  // 5 min
  const SHOT_ML    = 40;

  /* === HELPERS ========================================================= */
  // Construct the CSV export URL for a published sheet by GID
  const csvUrl = sheet =>
    `${PUB_BASE}/pub?gid=${sheet.gid}&single=true&output=csv`;

  const slug = str => str.toLowerCase().normalize('NFD')
                        .replace(/[̀-\u036f]/g, '')
                        .replace(/\s+/g, '_')
                        .replace(/[^\w\-]/g, '');
  const toNum = v => {
    if (typeof v === 'number') return v;
    if (!v) return 0;
    return parseFloat(String(v).replace(/%/g, '').replace(/,/g, '.')) || 0;
  };
  const toBool = v => /^(y|yes|true|1)$/i.test(String(v).trim());

  /* === DATA LAYER ====================================================== */
  async function fetchCsvByGid(sheet){
    const url = csvUrl(sheet);
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Cannot load sheet GID=${sheet.gid} (${r.status})`);
    const text = await r.text();
    return Papa.parse(text.trim(), { header: true }).data;
  }

  async function loadBarData(){
    const [invRaw, recRaw] = await Promise.all([
      fetchCsvByGid(SHEETS.INVENTORY),
      fetchCsvByGid(SHEETS.RECIPES)
    ]);

    if (!invRaw.length) throw new Error('Inventory sheet empty');
    if (!recRaw.length) throw new Error('Recipes sheet empty');

    // auto-detect column keys
    const detect = (row, regex) => Object.keys(row).find(k => regex.test(k));
    const stockKey = detect(invRaw[0], /(stock|have|available|skladem)/i);
    const abvKey   = detect(invRaw[0], /(alkohol|abv)/i)       || 'Alkohol';
    const priceKey = detect(invRaw[0], /(cena.*\/l|price.*\/l)/i) || 'Cena/L';

    const inventory = invRaw.filter(r => r.Name).map(r => {
      const abvVal = toNum(r[abvKey]);
      const abv    = abvVal > 1 ? abvVal / 100 : abvVal;
      return {
        name: r.Name.trim(),
        abv,
        pricePerMl: toNum(r[priceKey]) / 1000,
        inStock: stockKey ? toBool(r[stockKey]) : true
      };
    });
    const invMap = Object.fromEntries(inventory.map(i => [i.name, i]));

    const shots = inventory
      .filter(i => i.abv > 0.05)
      .map(i => ({ name: i.name, price: +(i.pricePerMl * SHOT_ML).toFixed(2), available: i.inStock }))
      .sort((a, b) => a.name.localeCompare(b.name));

    const drinkNames = Object.keys(recRaw[0])
      .filter(k => k !== 'Name' && k && !k.startsWith('_') && !/^Unnamed/i.test(k));

    const drinks = {};
    recRaw.forEach(row => {
      const ingName = row.Name && row.Name.trim();
      if (!ingName || !invMap[ingName]) return;
      drinkNames.forEach(dn => {
        const ml = toNum(row[dn]);
        if (ml <= 0) return;
        const inv = invMap[ingName];
        const d = drinks[dn] ??= { name: dn, volumeMl: 0, alcPercent: 0, price: 0, available: true, missing: [], parts: [] };
        d.volumeMl  += ml;
        d.price     += ml * inv.pricePerMl;
        d.alcPercent+= ml * inv.abv;
        d.parts.push({ ingredient: ingName, ml, abv: +(inv.abv * 100).toFixed(1), inStock: inv.inStock });
        if (!inv.inStock) {
          d.available = false;
          if (!d.missing.includes(ingName)) d.missing.push(ingName);
        }
      });
    });

    for (const d of Object.values(drinks)) {
      d.alcPercent = +(d.alcPercent / d.volumeMl * 100).toFixed(2);
      d.price      = +d.price.toFixed(2);
      d.volumeMl   = +d.volumeMl.toFixed(0);
    }
    return { drinks, shots };
  }

  /* === UI HELPERS & RENDER ============================================ */
  const dot = avail => `<span class="status ${avail?'ok':'no'}"></span>`;
  const statusDot = d => `<span class="status ${d.available?'ok':'no'}" title="${d.available?'All ingredients in stock':'Missing: '+d.missing.join(', ')}"></span>`;

  function renderList(drinksMap, shots){
    const drinks = Object.values(drinksMap).sort((a,b)=>a.name.localeCompare(b.name));
    const app=document.getElementById('app');
    app.innerHTML='<h1>Drinks</h1>';
    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Drink</th><th style="text-align:center;width:1%">Availability</th><th>Price</th></tr></thead>';
    const tbody=document.createElement('tbody');
    drinks.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><a href="?drink=${encodeURIComponent(d.name)}">${d.name}</a></td><td style="text-align:center">${statusDot(d)}</td><td>${CURRENCY}${d.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    app.appendChild(tbl);
    if(shots.length){
      app.insertAdjacentHTML('beforeend','<h2>Shots</h2>');
      const sTbl=document.createElement('table');
      sTbl.innerHTML='<thead><tr><th>Shot (40 ml)</th><th style="text-align:center;width:1%">Availability</th><th>Price</th></tr></thead>';
      const sBody=document.createElement('tbody');
      shots.forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${s.name}</td><td style="text-align:center">${dot(s.available)}</td><td>${CURRENCY}${s.price.toFixed(2)}</
