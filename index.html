<!--
Home Bar Website – autorefreshing single‑page site
==================================================
**Version 3 – trims empty ghost drinks**

* Filters out any drink whose calculated volume = 0 ml → no more “_1”, “0 ml”,
  or orphan numeric rows in the list.
* Ignores recipe rows that aren’t present in **Inventory** – so a stray “50 ml”
  row or blank Name cell can’t pollute the output.
* Still auto‑refreshes every 5 minutes and handles EU decimals, % signs, etc.

Install
-------
Replace your existing **index.html** with this file, push to GitHub Pages or
serve locally (`python -m http.server`), and refresh.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root{--accent:#007bff; --border:#d0d0d0; --bg-head:#f4f4f4; --err:#c00;}
    body{font-family:system-ui,sans-serif;margin:1.5rem;line-height:1.5;}
    h1{margin-top:0;font-size:1.8rem;}
    a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid var(--border);padding:0.45rem 0.6rem;text-align:left;vertical-align:top;}
    th{background:var(--bg-head);}img{max-width:320px;height:auto;display:block;margin:1rem 0;border-radius:0.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.08);} .back{display:inline-block;margin-bottom:1rem;font-size:0.9rem;} .err{color:var(--err);max-width:600px;}
  </style>
</head>
<body>
  <div id="app">Loading …</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* CONFIG */
  const SHEET_ID = '1Vi7W4YksMjIfuO5sqtzIZJwOTClXsG8GXg6rHBczOwI';
  const SHEETS   = { INVENTORY:'Inventory', RECIPES:'DrinkList' };
  const CURRENCY = '€';
  const REFRESH_MS = 5*60*1000;   // 5 min

  const csvUrl = sheet =>
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;

  const slug = str => str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_').replace(/[^\w\-]/g,'');

  const toNum = v => {
    if(typeof v==='number') return v;
    if(!v) return 0;
    return parseFloat(String(v).replace('%','').replace(',','.'))||0;
  };

  /* DATA */
  async function fetchCsv(sheet){
    const r = await fetch(csvUrl(sheet));
    if(!r.ok) throw new Error(`Cannot load sheet “${sheet}” (${r.status})`);
    return Papa.parse((await r.text()).trim(),{header:true}).data;
  }

  async function loadBarData(){
    const [invRaw, recRaw] = await Promise.all([
      fetchCsv(SHEETS.INVENTORY), fetchCsv(SHEETS.RECIPES)
    ]);

    const inventory = invRaw.map(r=>({
      name:r.Name,
      abv: toNum(r.Alkohol)/(String(r.Alkohol).includes('%')?100:1),
      pricePerMl: toNum(r['Cena/L'])/1000
    }));
    const ingSet = new Set(inventory.map(i=>i.name));

    const drinkNames = Object.keys(recRaw[0]).filter(k=>k!=='Name' && k && !k.startsWith('_') && !/^Unnamed/i.test(k));
    const drinks = Object.fromEntries(drinkNames.map(n=>[n,{name:n,volumeMl:0,alcPercent:0,price:0,parts:[]}]));

    recRaw.forEach(row=>{
      const ingredient=row.Name;
      if(!ingredient || !ingSet.has(ingredient)) return;   // skip stray rows
      drinkNames.forEach(dn=>{
        const ml=toNum(row[dn]);
        if(ml>0){
          const inv=inventory.find(i=>i.name===ingredient) || {abv:0,pricePerMl:0};
          const d=drinks[dn];
          d.volumeMl+=ml;
          d.price+=ml*inv.pricePerMl;
          d.parts.push({ingredient,ml,abv:inv.abv*100});
        }
      });
    });

    // finalise + prune empties
    for(const [name,d] of Object.entries(drinks)){
      if(d.volumeMl===0){ delete drinks[name]; continue; }
      const alcMl=d.parts.reduce((s,p)=>s+p.ml*(p.abv/100),0);
      d.alcPercent=+(alcMl/d.volumeMl*100).toFixed(2);
      d.price=+d.price.toFixed(2);
      d.volumeMl=+d.volumeMl.toFixed(0);
    }
    return drinks;
  }

  /* UI */
  function renderList(drinks){
    const app=document.getElementById('app');
    app.innerHTML='<h1>Drinks</h1>';
    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Drink</th><th>Price</th></tr></thead>';
    const tbody=document.createElement('tbody');
    Object.values(drinks).forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><a href="?drink=${encodeURIComponent(d.name)}">${d.name}</a></td><td>${CURRENCY}${d.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); app.appendChild(tbl);
  }

  function renderDetail(d){
    const app=document.getElementById('app');
    app.innerHTML=`<a class="back" href="./">← Back to list</a><h1>${d.name}</h1>`;
    const img=document.createElement('img'); img.src=`images/${slug(d.name)}.jpg`; img.alt=d.name; img.onerror=()=>img.remove(); app.appendChild(img);
    app.insertAdjacentHTML('beforeend',`<p>Volume: <strong>${d.volumeMl} ml</strong><br>Alcohol: <strong>${d.alcPercent}% ABV</strong><br>Price: <strong>${CURRENCY}${d.price.toFixed(2)}</strong></p>`);
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>Ingredient</th><th>ml</th><th>ABV %</th></tr></thead>'; const tb=document.createElement('tbody'); d.parts.forEach(p=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.ingredient}</td><td>${p.ml}</td><td>${p.abv}</td>`; tb.appendChild(tr);}); tbl.appendChild(tb); app.appendChild(tbl);
    app.insertAdjacentHTML('beforeend','<p>Description coming soon…</p>');
  }

  /* BOOTSTRAP */
  async function render(){
    try{
      const drinks=await loadBarData();
      const qs=new URLSearchParams(location.search).get('drink');
      if(qs && drinks[qs]) renderDetail(drinks[qs]); else renderList(drinks);
    }catch(e){ document.getElementById('app').innerHTML=`<p class="err">${e.message}</p>`; console.error(e); }
  }
  render(); setInterval(render,REFRESH_MS);
  </script>
</body>
</html>
