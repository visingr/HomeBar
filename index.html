<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root { --accent: #007bff; --border: #d0d0d0; --bg-head: #f4f4f4; --err: #c00; }
    body { font-family: system-ui, sans-serif; margin: 1.5rem; line-height: 1.5; }
    h1, h2 { margin-top: 1.5rem; font-size: 1.8rem; }
    h2 { font-size: 1.4rem; }
    a { color: var(--accent); text-decoration: none; cursor: pointer; }
    a:hover { text-decoration: underline; }
    .back a { font-size: 0.9rem; display: inline-block; margin-bottom: 1rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid var(--border); padding: 0.45rem 0.6rem; text-align: left; vertical-align: top; }
    th { background: var(--bg-head); }
    .err { color: var(--err); max-width: 600px; }
    .status { display: inline-block; width: 0.8rem; height: 0.8rem; border-radius: 50%; vertical-align: middle; margin-right: 0.4rem; }
    .status.ok { background: #28a745; }
    .status.no { background: #dc3545; }
  </style>
</head>
<body>
  <div id="app">Loading …</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /* CONFIG */
    const PUB_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwUNtFVPmX6ltXE7XyM12GlTYBTjadWSeUSbUZL7_IFYQANa2o-FSj9gDIAWxH2T-lse9nvlEyMQUL';
    const SHEETS = { INVENTORY: { gid: 310073761 }, RECIPES: { gid: 358185124 } };
    const CURRENCY = '€';
    const REFRESH_MS = 5 * 60 * 1000;
    const SHOT_ML = 40;

    /* HELPERS */
    const csvUrl = sheet => `${PUB_BASE}/pub?gid=${sheet.gid}&single=true&output=csv`;
    const toNum = v => typeof v === 'number' ? v : (!v ? 0 : parseFloat(String(v).replace(/%/g, '').replace(/,/g, '.')) || 0);
    const toBool = v => /^(y|yes|true|1)$/i.test(String(v).trim());

    async function fetchCsv(sheet) {
      const res = await fetch(csvUrl(sheet));
      if (!res.ok) throw new Error(`Cannot load sheet GID=${sheet.gid} (${res.status})`);
      const text = await res.text();
      return Papa.parse(text.trim(), { header: true }).data;
    }

    async function loadBarData() {
      const [invRaw, recRaw] = await Promise.all([
        fetchCsv(SHEETS.INVENTORY),
        fetchCsv(SHEETS.RECIPES)
      ]);
      const detect = (row, rx) => Object.keys(row).find(k => rx.test(k));
      const stockKey = detect(invRaw[0], /(stock|have|available|skladem)/i);
      const abvKey = detect(invRaw[0], /(alkohol|abv)/i) || 'Alkohol';
      const priceKey = detect(invRaw[0], /(cena.*\/l|price.*\/l)/i) || 'Cena/L';

      const inventory = invRaw.filter(r => r.Name).map(r => {
        const abvv = toNum(r[abvKey]);
        return { name: r.Name.trim(), abv: abvv > 1 ? abvv / 100 : abvv, pricePerMl: toNum(r[priceKey]) / 1000, inStock: stockKey ? toBool(r[stockKey]) : true };
      });
      const invMap = Object.fromEntries(inventory.map(i => [i.name, i]));
      const shots = inventory.filter(i => i.abv > 0.05)
        .map(i => ({ name: i.name, price: +(i.pricePerMl * SHOT_ML).toFixed(2), available: i.inStock }))
        .sort((a, b) => a.name.localeCompare(b.name));

      const drinkNames = Object.keys(recRaw[0]).filter(k => k !== 'Name' && k && !k.startsWith('_') && !/^Unnamed/i.test(k));
      const drinks = {};
      recRaw.forEach(r => {
        const iname = r.Name && r.Name.trim();
        if (!iname || !invMap[iname]) return;
        drinkNames.forEach(dn => {
          const ml = toNum(r[dn]); if (ml <= 0) return;
          const inv = invMap[iname];
          const d = drinks[dn] ??= { name: dn, volumeMl: 0, alcPercent: 0, price: 0, available: true, missing: [], parts: [] };
          d.volumeMl += ml; d.price += ml * inv.pricePerMl; d.alcPercent += ml * inv.abv;
          d.parts.push({ ingredient: iname, ml, abv: +(inv.abv * 100).toFixed(1), inStock: inv.inStock });
          if (!inv.inStock) { d.available = false; if (!d.missing.includes(iname)) d.missing.push(iname); }
        });
      });
      Object.values(drinks).forEach(d => { d.alcPercent = +(d.alcPercent / d.volumeMl * 100).toFixed(2); d.price = +d.price.toFixed(2); d.volumeMl = +d.volumeMl.toFixed(0); });
      return { drinks, shots };
    }

    /* RENDER & ROUTING */
    let barData = null;
    function dot(ok) { return `<span class="status ${ok ? 'ok' : 'no'}" title="${ok ? 'Available' : 'Not available'}"></span>`; }
    function statusDot(d) { return `<span class="status ${d.available ? 'ok' : 'no'}" title="${d.available ? 'All ingredients in stock' : 'Missing: ' + d.missing.join(', ')}"></span>`; }

    function renderList() {
      const { drinks, shots } = barData;
      const app = document.getElementById('app'); app.innerHTML = '<h1>Drinks</h1>';
      const t = document.createElement('table');
      t.innerHTML = '<thead><tr><th>Drink</th><th style="text-align:center">Availability</th><th>Price</th></tr></thead>';
      const b = document.createElement('tbody');
      Object.values(drinks).sort((a, b) => a.name.localeCompare(b.name)).forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a data-drink="${d.name}">${d.name}</a></td>
          <td style="text-align:center">${statusDot(d)}</td>
          <td>${CURRENCY}${d.price.toFixed(2)}</td>`;
        b.appendChild(tr);
      }); t.appendChild(b); app.appendChild(t);

      if (shots.length) {
        app.insertAdjacentHTML('beforeend', '<h2>Shots (40 ml)</h2>');
        const st = document.createElement('table');
        st.innerHTML = '<thead><tr><th>Shot</th><th style="text-align:center">Availability</th><th>Price</th></tr></thead>';
        const sb = document.createElement('tbody');
        shots.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.name}</td><td style="text-align:center">${dot(s.available)}</td><td>${CURRENCY}${s.price.toFixed(2)}</td>`;
          sb.appendChild(tr);
        }); st.appendChild(sb); app.appendChild(st);
      }
    }

    function renderDetails(name) {
      const d = barData.drinks[name];
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="back"><a data-back>← All Drinks</a></div>
        <h1>${d.name}</h1>
        <p>${statusDot(d)} ${d.available ? '<strong>Available</strong>' : '<strong>Not available</strong>'}</p>
        <p>Volume: ${d.volumeMl} ml</p>
        <p>ABV: ${d.alcPercent}%</p>
        <p>Price: ${CURRENCY}${d.price.toFixed(2)}</p>`;
      const t = document.createElement('table');
      t.innerHTML = '<thead><tr><th>Ingredient</th><th>Amount (ml)</th><th>ABV (%)</th><th style="text-align:center">In Stock</th></tr></thead>';
      const b = document.createElement('tbody');
      d.parts.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.ingredient}</td><td>${p.ml}</td><td>${p.abv}</td><td style="text-align:center">${dot(p.inStock)}</td>`;
        b.appendChild(tr);
      }); t.appendChild(b); app.appendChild(t);
    }

    function router() {
      const params = new URLSearchParams(location.search);
      const drink = params.get('drink');
      if (barData) {
        if (drink) renderDetails(drink);
        else renderList();
      }
    }

    // Intercept link clicks for SPA navigation
    document.body.addEventListener('click', e => {
      const a = e.target.closest('a');
      if (!a) return;
      if (a.hasAttribute('data-drink')) {
        e.preventDefault();
        const name = a.getAttribute('data-drink');
        history.pushState({ drink: name }, '', `?drink=${encodeURIComponent(name)}`);
        renderDetails(name);
      } else if (a.hasAttribute('data-back')) {
        e.preventDefault();
        history.pushState({}, '', location.pathname);
        renderList();
      }
    });

    window.addEventListener('popstate', router);

    // Initial load and caching
    loadBarData().then(data => {
      barData = data;
      router();
      // Periodic refresh of cache
      setInterval(async () => { barData = await loadBarData(); router(); }, REFRESH_MS);
    }).catch(e => {
      document.getElementById('app').innerHTML = `<p class="err">${e.message}</p>`;
      console.error(e);
    });
  </script>
</body>
</html>
