<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root { --accent: #007bff; --border: #d0d0d0; --bg-head: #f4f4f4; --err: #c00; }
    body { position: relative; font-family: system-ui, sans-serif; margin: 1.5rem; line-height: 1.5; }
    .lang-switch { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
    .lang-switch img { width: 24px; height: 24px; cursor: pointer; border: 1px solid transparent; border-radius: 0.25rem; }
    .lang-switch img.active { border-color: var(--accent); }
    h1, h2 { margin-top: 1.5rem; font-size: 1.8rem; }
    h2 { font-size: 1.4rem; }
    a { color: var(--accent); text-decoration: none; cursor: pointer; }
    a:hover { text-decoration: underline; }
    .back { display: inline-block; margin-bottom: 1rem; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 0.25rem; background: var(--bg-head); }
    .back a { font-size: 0.9rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid var(--border); padding: 0.45rem 0.6rem; text-align: left; vertical-align: top; }
    th { background: var(--bg-head); cursor: pointer; user-select: none; }
    .err { color: var(--err); max-width: 600px; }
    .status { display: inline-block; width: 0.8rem; height: 0.8rem; border-radius: 50%; vertical-align: middle; margin-right: 0.4rem; }
    .status.ok { background: #28a745; }
    .status.no { background: #dc3545; }
    .sort-indicator { font-size: 0.6rem; margin-left: 0.2rem; }
  </style>
</head>
<body>
  <div class="lang-switch">
    <img id="lang-en" src="Lang/united-kingdom.png" alt="English" title="English" class="active">
    <img id="lang-cs" src="Lang/czech-republic.png" alt="Čeština" title="Čeština">
  </div>
  <div id="app">Loading …</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /* CONFIG */
    const PUB_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwUNtFVPmX6ltXE7XyM12GlTYBTjadWSeUSbUZL7_IFYQANa2o-FSj9gDIAWxH2T-lse9nvlEyMQUL';
    const SHEETS = { INVENTORY: { gid: 310073761 }, RECIPES: { gid: 358185124 } };
    const CURRENCY = '€';
    const REFRESH_MS = 60 * 1000;

    /* TRANSLATIONS */
    const dict = {
      en: { loading: 'Loading …', drinks: 'Drinks', shots: 'Shots (40 ml)', availability: 'Availability', price: 'Price', back: '← All Drinks', volume: 'Volume', abv: 'ABV', ingredient: 'Ingredient', amount: 'Amount (ml)', abvPct: 'ABV (%)', inStock: 'In Stock', available: 'Available', notAvailable: 'Not available', description: 'Description' },
      cs: { loading: 'Načítání …', drinks: 'Nápoje', shots: 'Panáky (40 ml)', availability: 'Dostupnost', price: 'Cena', back: '← Všechny nápoje', volume: 'Objem', abv: 'Alkohol', ingredient: 'Ingredience', amount: 'Množství (ml)', abvPct: 'Alkohol (%)', inStock: 'Skladem', available: 'Dostupné', notAvailable: 'Není dostupné', description: 'Popis' }
    };
    let lang = 'en'; function t(key) { return dict[lang][key]; }

    /* SORT STATE */
    let sortKey = 'name'; // 'name', 'availability', or 'price'
    let sortAsc = true;
    let shotSortKey = 'name';
    let shotSortAsc = true;

    /* HELPERS */
    const csvUrl = sheet => `${PUB_BASE}/pub?gid=${sheet.gid}&single=true&output=csv`;
    const toNum  = v => typeof v==='number'? v : (!v?0: parseFloat(String(v).replace(/%/g,'').replace(/,/g,'.'))||0);
    const toBool = v => /^(y|yes|true|1)$/i.test(String(v).trim());

    async function fetchCsv(sheet) {
      const res = await fetch(csvUrl(sheet)); if(!res.ok) throw new Error(`Cannot load GID ${sheet.gid}`);
      return res.text();
    }

    async function loadBarData() {
      const [invText, recText] = await Promise.all([ fetchCsv(SHEETS.INVENTORY), fetchCsv(SHEETS.RECIPES) ]);
      const invRaw = Papa.parse(invText.trim(), { header: true }).data;
      const recRaw = Papa.parse(recText.trim(), { header: true }).data;

      const detect = (row, rx) => Object.keys(row).find(k=> rx.test(k));
      const stockKey = detect(invRaw[0], /(stock|have|available|skladem)/i);
      const abvKey   = detect(invRaw[0], /(alkohol|abv)/i) || 'Alkohol';
      const priceKey = detect(invRaw[0], /(cena.*\/l|price.*\/l)/i) || 'Cena/L';

      const inventory = invRaw.filter(r=>r.Name).map(r=>{
        const a = toNum(r[abvKey]);
        return { name: r.Name.trim(), abv: a>1? a/100 : a, pricePerMl: toNum(r[priceKey])/1000, inStock: stockKey? toBool(r[stockKey]): true };
      });
      const invMap = Object.fromEntries(inventory.map(i=>[i.name,i]));
      const shots  = inventory.filter(i=>i.abv>0.05).map(i=>({ name: i.name, price: +(i.pricePerMl*40).toFixed(2), available: i.inStock }));

      const names = Object.keys(recRaw[0]).filter(k=> k!=='Name' && k && !k.startsWith('_') && !/^Unnamed/i.test(k));
      const descRows = recRaw.filter((r,idx)=> idx>0 && !r.Name && Object.keys(r).some(k=>k!=='Name'&&r[k]));
      const descRowCs = descRows[0]||{}, descRowEn = descRows[1]||{};

      const drinks = {};
      recRaw.filter(r=>r.Name).forEach(r=>{
        const iname = r.Name.trim(); if(!invMap[iname]) return;
        names.forEach(dn=>{
          const ml = toNum(r[dn]); if(ml<=0) return;
          const inv = invMap[iname];
          if(!drinks[dn]) drinks[dn] = { name: dn, volumeMl: 0, alcPercent: 0, price: 0, available: true, missing: [], parts: [], description: { en: descRowEn[dn]||'', cs: descRowCs[dn]||'' } };
          const d = drinks[dn];
          d.volumeMl += ml;
          d.price += ml * inv.pricePerMl;
          d.alcPercent += ml * inv.abv;
          d.parts.push({ ingredient: iname, ml, abv: +(inv.abv*100).toFixed(1), inStock: inv.inStock });
          if(!inv.inStock) { d.available = false; if(!d.missing.includes(iname)) d.missing.push(iname); }
        });
      });
      Object.values(drinks).forEach(d=>{ d.alcPercent = +(d.alcPercent/d.volumeMl*100).toFixed(2); d.price = +d.price.toFixed(2); d.volumeMl = +d.volumeMl.toFixed(0); });

      return { drinks, shots };
    }

    function dot(avail, missing=[]) {
      const cls = avail? 'ok':'no';
      const title = avail? t('available') : missing.length? `Missing: ${missing.join(', ')}` : t('notAvailable');
      return `<span class="status ${cls}" title="${title}"></span>`;
    }
    function statusDot(d) { return dot(d.available, d.missing); }

    let barData = {};

    function renderList() {
      const { drinks, shots } = barData;
      const app = document.getElementById('app');
      app.innerHTML = `<h1>${t('drinks')}</h1>`;

      // Drinks Table
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      ['name','availability','price'].forEach(key => {
        const th = document.createElement('th');
        const label = key==='name'? t('drinks') : key=== 'availability'? t('availability') : t('price');
        const active = sortKey===key;
        const indicator = active? (sortAsc? '▲':'▼') : '';
        th.innerHTML = `${label}<span class="sort-indicator">${indicator}</span>`;
        th.style.textAlign = key==='availability'? 'center':'left';
        th.addEventListener('click', ()=>{
          if(sortKey===key) sortAsc = !sortAsc;
          else { sortKey = key; sortAsc = true; }
          renderList();
        });
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let list = Object.values(drinks).slice();
      if(sortKey==='availability') {
        const availList = list.filter(d=>d.available).map(d=>d);
        const notList = list.filter(d=>!d.available).map(d=>d);
        availList.sort((a,b)=> sortAsc
          ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
          : b.name.toLowerCase().localeCompare(a.name.toLowerCase())
        );
        notList.sort((a,b)=> sortAsc
          ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
          : b.name.toLowerCase().localeCompare(a.name.toLowerCase())
        );
        list = [...availList, ...notList];
      } else {
        list.sort((a,b)=>{
          if(sortKey==='name') return sortAsc
            ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
            : b.name.toLowerCase().localeCompare(a.name.toLowerCase());
          return sortAsc
            ? a.price - b.price
            : b.price - a.price;
        });
      }
      list.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><a data-drink="${d.name}">${d.name}</a></td><td style="text-align:center">${statusDot(d)}</td><td>${CURRENCY}${d.price.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      app.appendChild(table);

      // Shots Table
      if(shots.length) {
        app.insertAdjacentHTML('beforeend', `<h2>${t('shots')}</h2>`);
        const st = document.createElement('table');
        const sHead = document.createElement('thead');
        const sr = document.createElement('tr');
        ['name','availability','price'].forEach(key => {
          const th = document.createElement('th');
          const label = key==='name'? t('shots') : key=== 'availability'? t('availability') : t('price');
          const active = shotSortKey===key;
          const indicator = active? (shotSortAsc? '▲':'▼') : '';
          th.innerHTML = `${label}<span class="sort-indicator">${indicator}</span>`;
          th.style.textAlign = key==='availability'? 'center':'left';
          th.addEventListener('click', ()=>{
            if(shotSortKey===key) shotSortAsc = !shotSortAsc;
            else { shotSortKey = key; shotSortAsc = true; }
            renderList();
          });
          sr.appendChild(th);
        });
        sHead.appendChild(sr);
        st.appendChild(sHead);

        const sb = document.createElement('tbody');
        let sList = shots.slice();
        if(shotSortKey==='availability') {
          const sAvail = sList.filter(s=>s.available);
          const sNot   = sList.filter(s=>!s.available);
          sAvail.sort((a,b)=> shotSortAsc
            ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
            : b.name.toLowerCase().localeCompare(a.name.toLowerCase())
          );
          sNot.sort((a,b)=> shotSortAsc
            ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
            : b.name.toLowerCase().localeCompare(a.name.toLowerCase())
          );
          sList = [...sAvail, ...sNot];
        } else {
          sList.sort((a,b)=>{
            if(shotSortKey==='name') return shotSortAsc
              ? a.name.toLowerCase().localeCompare(b.name.toLowerCase())
              : b.name.toLowerCase().localeCompare(a.name.toLowerCase());
            return shotSortAsc
              ? a.price - b.price
              : b.price - a.price;
          });
        }
        sList.forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.name}</td><td style="text-align:center">${dot(s.available)}</td><td>${CURRENCY}${s.price.toFixed(2)}</td>`;
          sb.appendChild(tr);
        });
        st.appendChild(sb);
        app.appendChild(st);
      }
    }

    function renderDetails(name) {
      const d = barData.drinks[name];
      const app = document.getElementById('app');
      app.innerHTML = `<div class=\"back\"><a data-back>${t('back')}</a></div><h1>${d.name}</h1><p>${statusDot(d)} <strong>${d.available? t('available'): t('notAvailable')}</strong></p><p>${t('volume')}: ${d.volumeMl} ml</p><p>${t('abv')}: ${d.alcPercent}%</p><p>${t('price')}: ${CURRENCY}${d.price.toFixed(2)}</p>`;
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>${t('ingredient')}</th><th>${t('amount')}</th><th>${t('abvPct')}</th><th style=\"text-align:center\">${t('inStock')}</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      d.parts.forEach(p=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.ingredient}</td><td>${p.ml}</td><td>${p.abv}</td><td style=\"text-align:center\">${dot(p.inStock)}</td>`; tbody.appendChild(tr); });
      table.appendChild(tbody);
      app.appendChild(table);
      const desc = d.description[lang];
      if(desc) app.insertAdjacentHTML('beforeend', `<p><strong>${t('description')}:</strong> ${desc}</p>`);
    }

    function router() { const params = new URLSearchParams(location.search); const drink = params.get('drink'); if(drink && barData.drinks[drink]) renderDetails(drink); else renderList(); }

    document.body.addEventListener('click', e => { const a = e.target.closest('a'); if(!a) return; if(a.dataset.drink) { e.preventDefault(); history.pushState({drink:a.dataset.drink}, '', `?drink=${encodeURIComponent(a.dataset.drink)}`); router(); } else if(a.dataset.back!==undefined) { e.preventDefault(); history.pushState({}, '', location.pathname); router(); } });
    document.getElementById('lang-en').addEventListener('click', ()=>{ lang='en'; document.getElementById('lang-en').classList.add('active'); document.getElementById('lang-cs').classList.remove('active'); router(); });
    document.getElementById('lang-cs').addEventListener('click', ()=>{ lang='cs'; document.getElementById('lang-cs').classList.add('active'); document.getElementById('lang-en').classList.remove('active'); router(); });

    (async()=>{
      try {
        document.getElementById('app').textContent = t('loading');
        barData = await loadBarData();
        router();
        setInterval(async()=>{ barData = await loadBarData(); router(); }, REFRESH_MS);
      } catch(e) {
        document.getElementById('app').innerHTML = `<p class="err">${e.message}</p>`;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
