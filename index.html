<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root { --accent: #007bff; --border: #d0d0d0; --bg-head: #f4f4f4; --err: #c00; }
    body { position: relative; font-family: system-ui, sans-serif; margin: 1.5rem; line-height: 1.5; }
    .lang-switch { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
    .lang-switch img { width: 24px; height: 24px; cursor: pointer; border: 1px solid transparent; border-radius: 0.25rem; }
    .lang-switch img.active { border-color: var(--accent); }
    h1, h2 { margin-top: 1.5rem; font-size: 1.8rem; }
    h2 { font-size: 1.4rem; }
    a { color: var(--accent); text-decoration: none; cursor: pointer; }
    a:hover { text-decoration: underline; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid var(--border); }
    th { background: var(--bg-head); text-align: left; }
    .back { margin-bottom: 1rem; }
    .back a { font-size: 0.9rem; }
    .err { color: var(--err); }
  </style>
</head>
<body>
  <div class="lang-switch">
    <img data-lang="en" src="./img/flag-en.png" alt="EN" class="active">
    <img data-lang="cs" src="./img/flag-cs.png" alt="CS">
  </div>
  <div id="app"></div>

  <script>
    const CURRENCY = 'â‚¬';
    let lang = 'en';
    let barData;

    async function loadData() {
      const [inventoryRes, textsRes] = await Promise.all([
        fetch('./bar-data.json'),
        fetch('./i18n.json')
      ]);
      if (!inventoryRes.ok || !textsRes.ok) throw new Error('Failed to load data');
      const inventory = await inventoryRes.json();
      const texts = await textsRes.json();

      const drinks = {};
      inventory.forEach(i => {
        const abvPct = +(i.abv * 100).toFixed(1);
        if (abvPct <= 5) {
          drinks[i.name] = {
            name: i.name,
            volumeMl: i.volumeMl,
            alcPercent: abvPct,
            price: +(i.pricePerMl * i.volumeMl).toFixed(2),
            available: i.inStock,
            description: i.description,
            ingredients: i.ingredients || []
          };
        }
      });

      const shots = inventory
        .filter(i => +(i.abv * 100).toFixed(1) > 5)
        .map(i => ({
          name: i.name,
          alcPercent: +(i.abv * 100).toFixed(1),
          price: +(i.pricePerMl * 40).toFixed(2),
          available: i.inStock
        }));

      return { drinks, shots, texts };
    }

    function t(key) {
      return barData.texts[lang]?.[key] || key;
    }

    function statusDot(d) {
      const color = d.available ? 'green' : 'red';
      return `<span style="display:inline-block;width:0.75rem;height:0.75rem;background:${color};border-radius:50%;"></span>`;
    }

    function renderList() {
      const { drinks, shots } = barData;
      const app = document.getElementById('app');
      app.innerHTML = `<h1>${t('drinks')}</h1>`;

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>${t('drink')}</th>
            <th style="text-align:center">${t('availability')}</th>
            <th>${t('price')}</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');

      Object.values(drinks)
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(d => {
          const icon = d.alcPercent === 0
            ? '<img src="./img/AlcoholFree.png" alt="Nealko" style="width:16px;vertical-align:middle;margin-left:4px;">'
            : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><a data-drink="${d.name}">${d.name}${icon}</a></td>
            <td style="text-align:center">${statusDot(d)}</td>
            <td>${CURRENCY}${d.price.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });

      table.appendChild(tbody);
      app.appendChild(table);

      if (shots.length) {
        app.insertAdjacentHTML('beforeend', `<h2>${t('shots')}</h2>`);
        const st = document.createElement('table');
        st.innerHTML = `
          <thead>
            <tr>
              <th>${t('drink')}</th>
              <th style="text-align:center">${t('availability')}</th>
              <th>${t('price')}</th>
            </tr>
          </thead>`;
        const sb = document.createElement('tbody');
        shots.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><a data-drink="${s.name}">${s.name}</a></td>
            <td style="text-align:center">${statusDot(s)}</td>
            <td>${CURRENCY}${s.price.toFixed(2)}</td>
          `;
          sb.appendChild(tr);
        });
        st.appendChild(sb);
        app.appendChild(st);
      }
    }

    function renderDetails(name) {
      const d = barData.drinks[name];
      if (!d) return renderList();
      const app = document.getElementById('app');
      const icon = d.alcPercent === 0
        ? '<img src="./img/AlcoholFree.png" alt="Nealko" style="width:20px;vertical-align:middle;margin-left:8px;">'
        : '';
      app.innerHTML = `
        <div class="back"><a data-back>${t('back')}</a></div>
        <h1>${d.name}${icon}</h1>
        <p>${statusDot(d)} <strong>${d.available ? t('available') : t('notAvailable')}</strong></p>
        <p>${t('volume')}: ${d.volumeMl} ml</p>
        <p>${t('abv')}: ${d.alcPercent}%</p>
        <p>${t('price')}: ${CURRENCY}${d.price.toFixed(2)}</p>
      `;

      if (d.ingredients.length) {
        const table = document.createElement('table');
        table.innerHTML = `
          <thead><tr><th>${t('ingredient')}</th><th style="text-align:center">${t('amount')}</th></tr></thead>`;
        const tbody = document.createElement('tbody');
        d.ingredients.forEach(ing => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${ing.name}</td><td style="text-align:center">${ing.amountMl} ml</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        app.appendChild(table);
      }

      const desc = d.description?.[lang];
      if (desc) app.insertAdjacentHTML('beforeend', `<p><strong>${t('description')}:</strong> ${desc}</p>`);
    }

    function router() {
      const params = new URLSearchParams(window.location.search);
      const drink = params.get('drink');
      return drink ? renderDetails(decodeURIComponent(drink)) : renderList();
    }

    function setupEventListeners() {
      document.body.addEventListener('click', e => {
        const a = e.target.closest('a[data-drink], a[data-back]');
        if (!a) return;
        e.preventDefault();
        if (a.dataset.back !== undefined) history.pushState({}, '', window.location.pathname);
        else history.pushState({}, '', `?drink=${encodeURIComponent(a.dataset.drink)}`);
        router();
      });

      document.querySelectorAll('.lang-switch img').forEach(img => {
        img.addEventListener('click', () => {
          document.querySelectorAll('.lang-switch img').forEach(i => i.classList.remove('active'));
          img.classList.add('active');
          lang = img.dataset.lang;
          document.documentElement.lang = lang;
          router();
        });
      });

      window.addEventListener('popstate', router);
    }

    (async () => {
      try {
        barData = await loadData();
        setupEventListeners();
        router();
      } catch (err) {
        document.getElementById('app').innerHTML = `<p class="err">${err.message}</p>`;
        console.error(err);
      }
    })();
  </script>
</body>
</html>
