<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root{--accent:#007bff; --border:#d0d0d0; --bg-head:#f4f4f4; --err:#c00;}
    body{font-family:system-ui,sans-serif;margin:1.5rem;line-height:1.5;position:relative;}
    h1,h2{margin-top:1.5rem;font-size:1.8rem;}h2{font-size:1.4rem;}
    a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid var(--border);padding:0.45rem 0.6rem;text-align:left;vertical-align:top;}
    th{background:var(--bg-head);}img{max-width:320px;height:auto;display:block;margin:1rem 0;border-radius:0.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.08);} .back{display:inline-block;margin-bottom:1rem;font-size:0.9rem;} .err{color:var(--err);max-width:600px;}
    /* availability dots */
    .status{display:inline-block;width:0.8rem;height:0.8rem;border-radius:50%;vertical-align:middle;margin-right:0.4rem;}
    .status.ok{background:#28a745;}
    .status.no{background:#dc3545;}
    /* language switcher */
    #lang-switch{position:absolute;top:1rem;right:1rem;padding:0.25rem;font-size:0.9rem;}
  </style>
</head>
<body>
  <select id="lang-switch">
    <option value="en">English</option>
    <option value="cz">Čeština</option>
  </select>
  <div id="app">Loading …</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* === CONFIG ========================================================== */
  const SHEET_ID   = '1Vi7W4YksMjIfuO5sqtzIZJwOTClXsG8GXg6rHBczOwI';
  const SHEETS     = { INVENTORY:'Inventory', RECIPES:'DrinkList' };
  const CURRENCY   = '€';
  const REFRESH_MS = 5*60*1000;        // 5 min
  const SHOT_ML    = 40;               // standard shot size

  /* === I18N ============================================================ */
  const LANG = {
    en: { drinks:'Drinks', availability:'Availability', price:'Price', shots:'Shots', shot:'Shot (40 ml)', available:'Available', unavailable:'Unavailable', volume:'Volume', alcohol:'Alcohol', abvSuffix:'% ABV', ingredient:'Ingredient', ml:'ml', abvPercent:'ABV %', inStock:'In stock', back:'← Back to list' },
    cz: { drinks:'Nápoje', availability:'Dostupnost', price:'Cena', shots:'Panáky', shot:'Panák (40 ml)', available:'K dispozici', unavailable:'Není k dispozici', volume:'Objem', alcohol:'Obsah alkoholu', abvSuffix:'%', ingredient:'Ingredience', ml:'ml', abvPercent:'% alkoholu', inStock:'Na skladě', back:'← Zpět na seznam' }
  };
  let currentLang = localStorage.getItem('lang') || 'en';
  document.documentElement.lang = currentLang;
  document.getElementById('lang-switch').value = currentLang;
  document.getElementById('lang-switch').addEventListener('change', e=>{
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    document.documentElement.lang = currentLang;
    render();
  });

  /* === HELPERS ========================================================= */
  const csvUrl = sheet =>
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;

  const normalize = str => str.trim().toLowerCase().normalize('NFD')
                        .replace(/[̀-ͯ]/g,'')
                        .replace(/\s+/g,' ');

  const toNum = v => {
    if(typeof v==='number') return v;
    if(!v) return 0;
    return parseFloat(String(v).replace(/%/g,'').replace(/,/g,'.'))||0;
  };
  const toBool = v => /^(y|yes|true|1)$/i.test(String(v).trim());

  /* === DATA LAYER ====================================================== */
  async function fetchCsv(sheet){
    const r = await fetch(csvUrl(sheet));
    if(!r.ok) throw new Error(`Cannot load sheet “${sheet}” (${r.status})`);
    return Papa.parse((await r.text()).trim(),{header:true}).data;
  }

  async function loadBarData(){
    const [invRaw, recRaw] = await Promise.all([
      fetchCsv(SHEETS.INVENTORY), fetchCsv(SHEETS.RECIPES)
    ]);

    // build inventory map with normalization
    const invData = invRaw.filter(r=>r.Name).map(r=>{
      const name = r.Name.trim();
      const abvVal = toNum(r[r.match(/^(alkohol|abv)$/i)?.input] || r['Alkohol']);
      const abv = abvVal>1 ? abvVal/100 : abvVal;
      return {
        name,
        abv,
        pricePerMl: toNum(r[r.match(/^(cena.*\/l|price.*\/l)$/i)?.input] || r['Cena/L'])/1000,
        inStock: Object.keys(r).find(k=>/^(stock|have|available|skladem)$/i.test(k)) ? toBool(r[Object.keys(r).find(k=>/^(stock|have|available|skladem)$/i.test(k))]) : true
      };
    });
    const invMap = Object.fromEntries(invData.map(i=>[normalize(i.name), i]));

    /* ---- Shots ------------------------------------------------------- */
    const shots = invData
      .filter(i=>i.abv>0.05)
      .map(i=>({ name: i.name, price: +(i.pricePerMl*SHOT_ML).toFixed(2), available: i.inStock }))
      .sort((a,b)=>a.name.localeCompare(b.name));

    /* ---- Cocktails --------------------------------------------------- */
    const drinkNames = Object.keys(recRaw[0]).filter(k=>k!=='Name' && k);
    const drinks = {};
    recRaw.forEach(row=>{
      if(!row.Name) return;
      const key = normalize(row.Name);
      let inv = invMap[key];
      if(!inv) {
        // fallback partial match
        const match = Object.keys(invMap).find(k=>k.includes(key) || key.includes(k));
        if(match) inv = invMap[match];
      }
      if(!inv) return;
      drinkNames.forEach(dn=>{
        const ml = toNum(row[dn]); if(ml<=0) return;
        const d = drinks[dn] ??= { name: dn, volumeMl: 0, alcPercent: 0, price: 0, available: true, missing: [], parts: [] };
        d.volumeMl  += ml;
        d.price     += ml*inv.pricePerMl;
        d.alcPercent+= ml*inv.abv;
        d.parts.push({ ingredient: inv.name, ml, abv: +(inv.abv*100).toFixed(1), inStock: inv.inStock });
        if(!inv.inStock){ d.available = false; if(!d.missing.includes(inv.name)) d.missing.push(inv.name); }
      });
    });
    Object.values(drinks).forEach(d=>{
      d.alcPercent = +(d.alcPercent/d.volumeMl*100).toFixed(2);
      d.price      = +d.price.toFixed(2);
      d.volumeMl   = +d.volumeMl.toFixed(0);
    });
    return { drinks, shots, recRaw };
  }

  /* === RENDERING ====================================================== */
  function dot(ok){ return `<span class="status ${ok?'ok':'no'}"></span>`; }
  function statusDot(d){ return `<span class="status ${d.available?'ok':'no'}" title="${d.available?'All ingredients in stock':'Missing: '+d.missing.join(', ')}"></span>`; }

  function renderList(drinksMap, shots, labels){
    const drinks = Object.values(drinksMap).sort((a,b)=>a.name.localeCompare(b.name));
    const app=document.getElementById('app'); app.innerHTML=`<h1>${labels.drinks}</h1>`;

    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>${labels.drinks}</th><th style="text-align:center;width:1%">${labels.availability}</th><th>${labels.price}</th></tr></thead>`;
    const tbody=document.createElement('tbody');
    drinks.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=
        `<td><a href="?drink=${encodeURIComponent(d.name)}">${d.name}</a></td>`+
        `<td style="text-align:center">${statusDot(d)}</td>`+
        `<td>${CURRENCY}${d.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    }); tbl.appendChild(tbody); app.appendChild(tbl);

    if(shots.length){
      app.insertAdjacentHTML('beforeend', `<h2>${labels.shots}</h2>`);
      const sTbl=document.createElement('table');
      sTbl.innerHTML=`<thead><tr><th>${labels.shot}</th><th style="text-align:center;width:1%">${labels.availability}</th><th>${labels.price}</th></tr></thead>`;
      const sBody=document.createElement('tbody');
      shots.forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML=
          `<td>${s.name}</td>`+
          `<td style="text-align:center">${dot(s.available)}</td>`+
          `<td>${CURRENCY}${s.price.toFixed(2)}</td>`;
        sBody.appendChild(tr);
      }); sTbl.appendChild(sBody); app.appendChild(sTbl);
    }
  }

  function renderDetail(d, labels, recRaw){
    const app=document.getElementById('app');
    app.innerHTML=`<a class="back" href="./">${labels.back}</a><h1>${d.name}</h1>`;
    const img=document.createElement('img'); img.src=`images/${d.name.toLowerCase().normalize('NFD').replace(/[̀-\u036f]/g,'').replace(/\s+/g,'_')}.jpg`;
    img.alt=d.name; img.onerror=()=>img.remove(); app.appendChild(img);

    app.insertAdjacentHTML('beforeend',
      `${statusDot(d)}<strong>${d.available?labels.available:labels.unavailable}</strong><br>`+
      `${labels.volume}: <strong>${d.volumeMl} ${labels.ml}</strong><br>`+
      `${labels.alcohol}: <strong>${d.alcPercent}${labels.abvSuffix}</strong><br>`+
      `${labels.price}: <strong>${CURRENCY}${d.price.toFixed(2)}</strong>`);

    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>${labels.ingredient}</th><th>${labels.ml}</th><th>${labels.abvPercent}</th><th style="text-align:center;width:1%">${labels.inStock}</th></tr></thead>`;
    const tb=document.createElement('tbody');
    d.parts.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.ingredient}</td><td>${p.ml}</td><td>${p.abv}</td><td style="text-align:center">${dot(p.inStock)}</td>`;
      tb.appendChild(tr);
    }); tbl.appendChild(tb); app.appendChild(tbl);

    // description rows: 999th (cz) and 1000th (en)
    const czDesc = recRaw[998] && recRaw[998][d.name] ? recRaw[998][d.name] : '';
    const enDesc = recRaw[999] && recRaw[999][d.name] ? recRaw[999][d.name] : '';
    const desc = currentLang==='cz' ? czDesc : enDesc;
    if(desc) app.insertAdjacentHTML('beforeend', `<p>${desc}</p>`);
  }

  /* === APP BOOTSTRAP =================================================== */
  async function render(){
    try{
      const {drinks, shots, recRaw} = await loadBarData();
      const labels = LANG[currentLang];
      const qs=new URLSearchParams(location.search).get('drink');
      if(qs && drinks[qs]) renderDetail(drinks[qs], labels, recRaw);
      else renderList(drinks, shots, labels);
    }catch(e){
      document.getElementById('app').innerHTML=`<p class="err">${e.message}</p>`;
      console.error(e);
    }
  }
  render();
  setInterval(render, REFRESH_MS);
  </script>
</body>
</html>
