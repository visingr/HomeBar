<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root{--accent:#007bff; --border:#d0d0d0; --bg-head:#f4f4f4; --err:#c00;}
    body{font-family:system-ui,sans-serif;margin:1.5rem;line-height:1.5;position:relative;}
    h1,h2{margin-top:1.5rem;font-size:1.8rem;}h2{font-size:1.4rem;}
    a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid var(--border);padding:0.45rem 0.6rem;text-align:left;vertical-align:top;}
    th{background:var(--bg-head);}img{max-width:320px;height:auto;display:block;margin:1rem 0;border-radius:0.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.08);} .back{display:inline-block;margin-bottom:1rem;font-size:0.9rem;} .err{color:var(--err);max-width:600px;}
    .status{display:inline-block;width:0.8rem;height:0.8rem;border-radius:50%;vertical-align:middle;margin-right:0.4rem;}
    .status.ok{background:#28a745;}
    .status.no{background:#dc3545;}
    #lang-switch{position:absolute;top:1rem;right:1rem;padding:0.25rem;font-size:0.9rem;}
  </style>
</head>
<body>
  <select id="lang-switch">
    <option value="en">English</option>
    <option value="cz">Čeština</option>
  </select>
  <div id="app">Loading …</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* === CONFIG === */
  const SHEET_ID   = '1Vi7W4YksMjIfuO5sqtzIZJwOTClXsG8GXg6rHBczOwI';
  const SHEETS     = { INVENTORY:'Inventory', RECIPES:'DrinkList' };
  const CURRENCY   = '€';
  const REFRESH_MS = 5*60*1000;
  const SHOT_ML    = 40;

  /* === I18N === */
  const LANG = { /* ... your translations here ... */ };
  let currentLang = localStorage.getItem('lang') || 'en';
  document.documentElement.lang = currentLang;
  document.getElementById('lang-switch').value = currentLang;
  document.getElementById('lang-switch').addEventListener('change', e=>{
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    document.documentElement.lang = currentLang;
    render();
  });

  /* === HELPERS === */
  const csvUrl = sheet => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;
  const normalize = str => String(str || "")
                         .trim()
                         .toLowerCase()
                         .normalize('NFD')
                         .replace(/[̀-ͯ]/g, '')
                         .replace(/[\u00A0]/g, ' ')
                         .replace(/\s+/g,' ');
  const toNum = v => typeof v==='number'?v:(!v?0:parseFloat(String(v).replace(/%/g,'').replace(/,/g,'.'))||0);
  const toBool = v => /^(y|yes|true|1)$/i.test(String(v).trim());

  /* === DATA LAYER === */
  async function fetchCsv(sheet){
    const r = await fetch(csvUrl(sheet));
    if(!r.ok) throw new Error(`Cannot load sheet “${sheet}” (${r.status})`);
    return Papa.parse((await r.text()).trim(),{header:true}).data;
  }

  async function loadBarData(){
    const [invRaw, recRaw] = await Promise.all([
      fetchCsv(SHEETS.INVENTORY),
      fetchCsv(SHEETS.RECIPES)
    ]);

    // Build normalized inventory map
    const inventory = invRaw
      .filter(r => r.Name)
      .map(r => {
        const nameRaw = String(r.Name);
        const abvVal  = toNum(r['Alkohol']);
        const abv     = abvVal > 1 ? abvVal/100 : abvVal;
        return {
          name: nameRaw.trim(),
          key: normalize(nameRaw),
          abv,
          pricePerMl: toNum(r['Cena/L'])/1000,
          inStock: toBool(r['Skladem'])
        };
      });

    const invMap = Object.fromEntries(
      inventory.map(item => [item.key, item])
    );

    // Prepare shots list
    const shots = inventory
      .filter(i => i.abv > 0.05)
      .map(i => ({ name: i.name, price: +(i.pricePerMl*SHOT_ML).toFixed(2), available: i.inStock }))
      .sort((a,b) => a.name.localeCompare(b.name));

    // Parse drinks
    const drinkNames = Object.keys(recRaw[0]).filter(k => k !== 'Name');
    const drinks = {};

    recRaw.forEach(row => {
      if(!row.Name) return;
      const rawName = row.Name;
      const key     = normalize(rawName);
      let inv       = invMap[key];

      // Fallback fuzzy match if exact key not found
      if(!inv){
        const strippedKey = key.replace(/\s+/g, '');
        const match = Object.keys(invMap).find(k2 => {
          const stripped = k2.replace(/\s+/g, '');
          return k2.includes(key) || key.includes(k2) || stripped.includes(strippedKey) || strippedKey.includes(stripped);
        });
        if(match) inv = invMap[match];
      }
      if(!inv) return;

      // Assign ml values to each drink column
      drinkNames.forEach(dn => {
        const ml = toNum(row[dn]);
        if(ml <= 0) return;
        const d = drinks[dn] ??= { name: dn, volumeMl:0, alcPercent:0, price:0, available:true, missing:[], parts:[] };
        d.volumeMl += ml;
        d.price    += ml * inv.pricePerMl;
        d.alcPercent += ml * inv.abv;
        d.parts.push({ ingredient: inv.name, ml, abv: +(inv.abv*100).toFixed(1), inStock: inv.inStock });
        if(!inv.inStock){ d.available = false; if(!d.missing.includes(inv.name)) d.missing.push(inv.name); }
      });
    });

    // Finalize drink calculations
    Object.values(drinks).forEach(d => {
      d.alcPercent = +(d.alcPercent/d.volumeMl*100).toFixed(2);
      d.price      = +d.price.toFixed(2);
      d.volumeMl   = +d.volumeMl.toFixed(0);
    });

    return { drinks, shots, recRaw };
  }

  /* === RENDERING === */
  function dot(ok){ return `<span class="status ${ok?'ok':'no'}"></span>`; }
  function statusDot(d){ return `<span class="status ${d.available?'ok':'no'}" title="${d.available?'All ingredients in stock':'Missing: '+d.missing.join(', ')}"></span>`; }

  function renderList(drinksMap, shots, labels){ /* ... unchanged ... */ }
  function renderDetail(d, labels, recRaw){ /* ... unchanged ... */ }

  /* === BOOTSTRAP === */
  async function render(){
    try{
      const { drinks, shots, recRaw } = await loadBarData();
      const labels = LANG[currentLang];
      const qs = new URLSearchParams(location.search).get('drink');
      if(qs && drinks[qs]) renderDetail(drinks[qs], labels, recRaw);
      else renderList(drinks, shots, labels);
    } catch(e){
      document.getElementById('app').innerHTML = `<p class="err">${e.message}</p>`;
      console.error(e);
    }
  }

  render();
  setInterval(render, REFRESH_MS);
  </script>
</body>
</html>
