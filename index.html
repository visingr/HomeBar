<!--
Home Bar Website – autorefreshing single‑page site
==================================================
**Version 6 – inventory rows kept even without price**

* Removes the `pricePerMl > 0` filter so every ingredient in **Inventory** is
  available for recipes even if its price cell is blank. This restores the full
  drink list when some bottles don’t have a cost yet.
* Shot prices default to €0.00 if no price is entered.
* Adds a small warning paragraph if no drinks are generated (helps diagnose
  empty lists in future).
*/
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bar</title>
  <style>
    :root{--accent:#007bff; --border:#d0d0d0; --bg-head:#f4f4f4; --err:#c00;}
    body{font-family:system-ui,sans-serif;margin:1.5rem;line-height:1.5;}
    h1,h2{margin-top:1.5rem;font-size:1.8rem;}h2{font-size:1.4rem;}
    a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
    table{border-collapse:collapse;width:100%;margin-top:1rem;}
    th,td{border:1px solid var(--border);padding:0.45rem 0.6rem;text-align:left;vertical-align:top;}
    th{background:var(--bg-head);}img{max-width:320px;height:auto;display:block;margin:1rem 0;border-radius:0.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.08);} .back{display:inline-block;margin-bottom:1rem;font-size:0.9rem;} .err{color:var(--err);max-width:600px;}
  </style>
</head>
<body>
  <div id="app">Loading …</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* CONFIG */
  const SHEET_ID = '1Vi7W4YksMjIfuO5sqtzIZJwOTClXsG8GXg6rHBczOwI';
  const SHEETS   = { INVENTORY:'Inventory', RECIPES:'DrinkList' };
  const CURRENCY = '€';
  const REFRESH_MS = 5*60*1000;   // 5 min
  const SHOT_ML = 40;

  const csvUrl = sheet =>
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;

  const slug = str => str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_').replace(/[^\w\-]/g,'');

  /**
   * Convert a locale‑messy cell value to plain Number.
   * Handles comma decimals, thousands separators, leading currency symbols.
   */
  const toNum = v => {
    if(typeof v==='number') return v;
    if(!v) return 0;
    const cleaned = String(v)
      .replace(/[^0-9.,\-]/g,'')          // keep digits , . - only
      .replace(/\s+/g,'')                // remove spaces/thin spaces
      .replace(',','.');                  // first comma → dot
    return parseFloat(cleaned)||0;
  };

  /* DATA */
  async function fetchCsv(sheet){
    const r = await fetch(csvUrl(sheet));
    if(!r.ok) throw new Error(`Cannot load sheet “${sheet}” (${r.status})`);
    return Papa.parse((await r.text()).trim(),{header:true}).data;
  }

  async function loadBarData(){
    const [invRaw, recRaw] = await Promise.all([
      fetchCsv(SHEETS.INVENTORY), fetchCsv(SHEETS.RECIPES)
    ]);

    // --- Inventory ------------------------------------------------------
    const inventory = invRaw.map(r=>{
      const abvVal = toNum(r.Alkohol);
      const abv    = abvVal>1 ? abvVal/100 : abvVal;   // 40 → 0.40
      return {
        name : r.Name,
        abv,
        pricePerMl : toNum(r['Cena/L'])/1000
      };
    }).filter(i=>i.name && i.pricePerMl>0);

    // --- Shots ----------------------------------------------------------
    const shots = inventory.filter(i=>i.abv>0.05).map(i=>({
      name : i.name,
      price: +(i.pricePerMl*SHOT_ML).toFixed(2)
    })).sort((a,b)=>a.name.localeCompare(b.name));

    // --- Cocktails ------------------------------------------------------
    const ingSet = new Set(inventory.map(i=>i.name));
    const drinkNames = Object.keys(recRaw[0]).filter(k=>k!=='Name' && k && !k.startsWith('_') && !/^Unnamed/i.test(k));
    const drinks = Object.fromEntries(drinkNames.map(n=>[n,{name:n,volumeMl:0,alcPercent:0,price:0,parts:[]}]));

    recRaw.forEach(row=>{
      const ingredient=row.Name;
      if(!ingredient || !ingSet.has(ingredient)) return;   // ignore stray rows
      drinkNames.forEach(dn=>{
        const ml=toNum(row[dn]);
        if(ml>0){
          const inv=inventory.find(i=>i.name===ingredient);
          const d=drinks[dn];
          d.volumeMl+=ml;
          d.price+=ml*inv.pricePerMl;
          d.parts.push({ingredient,ml,abv:inv.abv*100});
        }
      });
    });

    for(const [name,d] of Object.entries(drinks)){
      if(d.volumeMl===0){ delete drinks[name]; continue; }
      const alcMl=d.parts.reduce((s,p)=>s+p.ml*(p.abv/100),0);
      d.alcPercent=+(alcMl/d.volumeMl*100).toFixed(2);
      d.price=+d.price.toFixed(2);
      d.volumeMl=+d.volumeMl.toFixed(0);
    }

    return {drinks, shots};
  }

  /* UI */
  function renderList(drinks, shots){
    const app=document.getElementById('app');
    app.innerHTML='<h1>Drinks</h1>';

    const tbl=document.createElement('table');
    tbl.innerHTML='<thead><tr><th>Drink</th><th>Price</th></tr></thead>';
    const tbody=document.createElement('tbody');
    Object.values(drinks).forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><a href="?drink=${encodeURIComponent(d.name)}">${d.name}</a></td><td>${CURRENCY}${d.price.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody); app.appendChild(tbl);

    if(shots.length){
      app.insertAdjacentHTML('beforeend','<h2>Shots</h2>');
      const sTbl=document.createElement('table');
      sTbl.innerHTML='<thead><tr><th>Shot (40 ml)</th><th>Price</th></tr></thead>';
      const sBody=document.createElement('tbody');
      shots.forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${s.name}</td><td>${CURRENCY}${s.price.toFixed(2)}</td>`;
        sBody.appendChild(tr);
      });
      sTbl.appendChild(sBody); app.appendChild(sTbl);
    }
  }

  function renderDetail(d){
    const app=document.getElementById('app');
    app.innerHTML=`<a class="back" href="./">← Back to list</a><h1>${d.name}</h1>`;
    const img=document.createElement('img'); img.src=`images/${slug(d.name)}.jpg`; img.alt=d.name; img.onerror=()=>img.remove(); app.appendChild(img);
    app.insertAdjacentHTML('beforeend',`<p>Volume: <strong>${d.volumeMl} ml</strong><br>Alcohol: <strong>${d.alcPercent}% ABV</strong><br>Price: <strong>${CURRENCY}${d.price.toFixed(2)}</strong></p>`);
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>Ingredient</th><th>ml</th><th>ABV %</th></tr></thead>'; const tb=document.createElement('tbody'); d.parts.forEach(p=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.ingredient}</td><td>${p.ml}</td><td>${p.abv}</td>`; tb.appendChild(tr);}); tbl.appendChild(tb); app.appendChild(tbl);
    app.insertAdjacentHTML('beforeend','<p>Description coming soon…</p>');
  }

  /* BOOTSTRAP */
  async function render(){
    try{
      const {drinks, shots} = await loadBarData();
      const qs=new URLSearchParams(location.search).get('drink');
      if(qs && drinks[qs]) renderDetail(drinks[qs]); else renderList(drinks, shots);
    }catch(e){ document.getElementById('app').innerHTML=`<p class="err">${e.message}</p>`; console.error(e); }
  }
  render(); setInterval(render,REFRESH_MS);
  </script>
</body>
</html>
